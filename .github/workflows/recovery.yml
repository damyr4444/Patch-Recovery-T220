name: RECOVERY

on:
  workflow_dispatch:
    inputs:
      RECOVERY_URL:
        description: 'DIRECT Link to recovery.img (use catbox.moe)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Check Out
      uses: actions/checkout@v4

    - name: Prepare the environment
      run: |
        sudo apt update
        sudo apt install git wget lz4 tar openssl python3 -y

    - name: Fetch image from URL
      run: |
        # Use -L to follow redirects and --tries for stability
        wget -L --tries=3 "${{ github.event.inputs.RECOVERY_URL }}" -O recovery.img
        if [ $(stat -c%s "recovery.img") -lt 1000000 ]; then
          echo "ERROR: The file is too small. Check if the link is a direct download."
          exit 1
        fi

    - name: Patch Process
      run: |
        # 1. Give everything execution permission
        chmod a+x script1.sh script2.sh magiskboot avbtool

        # 2. FORCE FIX: Replace any hardcoded absolute paths with the local directory
        # This looks for the old path in script2.sh and replaces it with the actual current path
        sed -i 's|/home/runner/work/[^/ ]*/[^/ ]*/|./|g' script2.sh
        
        # 3. Verify the fix (optional, helps debugging)
        echo "Checking line 8 of script2.sh for fix:"
        sed -n '8p' script2.sh

        # 4. Run the patching logic
        ./script1.sh
        ./script2.sh
        
        # 5. Check if the image was actually created
        if [ ! -f "new-boot.img" ] && [ ! -f "recovery-patched.img" ]; then
          echo "ERROR: Patching failed! magiskboot likely did not run."
          exit 1
        fi

        # 6. AVB Signing
        python3 avbtool extract_public_key --key phh.pem --output phh.pub.bin
        
        # Use recovery-patched.img if script2 created it, otherwise use new-boot.img
        SOURCE_IMG="new-boot.img"
        if [ -f "recovery-patched.img" ]; then SOURCE_IMG="recovery-patched.img"; fi
        
        python3 avbtool add_hash_footer \
          --partition_name recovery \
          --partition_size $(stat -c%s recovery.img) \
          --image "$SOURCE_IMG" \
          --key phh.pem \
          --algorithm SHA256_RSA4096
        
        # 7. Package for Odin
        mkdir -p output
        cp "$SOURCE_IMG" output/recovery.img
        cd output
        tar -H ustar -c recovery.img > fastbootd-recovery.tar
        md5sum -b fastbootd-recovery.tar | cut -d ' ' -f 1 >> fastbootd-recovery.tar
        mv fastbootd-recovery.tar fastbootd-recovery.tar.md5
    - name: Upload Recovery
      uses: actions/upload-artifact@v4
      with:
        name: Patched-Recovery
        path: output/fastbootd-recovery.tar.md5
